<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTS Table Explorer — Demo UI</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:20px auto;padding:0 16px;color:#222}
    header{display:flex;align-items:center;justify-content:space-between}
    input[type=text]{width:60%;padding:8px;border:1px solid #ddd;border-radius:6px}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
    .list{margin-top:16px;display:grid;grid-template-columns:1fr;gap:10px}
    .item{border:1px solid #eee;padding:10px;border-radius:8px;display:flex;gap:12px;align-items:flex-start}
    .photo{width:64px;height:64px;border-radius:8px;object-fit:cover}
    .meta{flex:1}
    .story{white-space:pre-wrap;color:#333;margin-top:8px}
    .controls{display:flex;gap:8px}
    .editor{margin-top:12px}
    .login{margin-left:12px}
    .notice{color:#666;font-size:13px;margin-top:8px}
    footer{margin-top:24px;color:#666;font-size:13px}
    textarea{font-family:inherit}
  </style>
</head>
<body>
  <header>
    <h1>FTS Table Explorer — Demo UI</h1>
    <div>
      <input id="q" type="text" placeholder="Search (server FTS)" />
      <button id="searchBtn">Search</button>
      <button id="fuzzyBtn">Fuzzy (client)</button>
      <button id="refreshBtn">Refresh</button>
      <button id="loginBtn" class="login">Login</button>
    </div>
  </header>

  <div class="notice">Tip: Use "Fuzzy" to search locally across all records. Use "Search" to query the server FTS index.</div>

  <div id="results" class="list"></div>

  <div id="detail"></div>

  <footer>Backend API endpoints used: <code>/api/users</code>, <code>/api/users/all</code>, <code>/api/users/:id</code>, <code>/api/login</code>, <code>/api/users/:id (PUT)</code></footer>

<script>
(async function(){
  const $ = id=>document.getElementById(id);
  const q = $('q');
  const results = $('results');
  const detail = $('detail');
  const searchBtn = $('searchBtn');
  const fuzzyBtn = $('fuzzyBtn');
  const refreshBtn = $('refreshBtn');
  const loginBtn = $('loginBtn');

  let allCache = null; // cache for /api/users/all

  function makeItemHtml(u){
    return `
      <div class="item" data-id="${u.id}">
        <img class="photo" src="${u.photo || 'https://i.pravatar.cc/150?u=unknown'}" alt="photo" />
        <div class="meta">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${escapeHtml(u.name)}</strong> — ${escapeHtml(u.city||'')} ${u.country?'- '+escapeHtml(u.country):''}</div>
            <div class="controls"><button class="view">View</button></div>
          </div>
          <div class="story">${escapeHtml(truncate(u.story||'',200))}</div>
        </div>
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function truncate(s,n){return s && s.length>n ? s.slice(0,n-1)+'…' : s}

  async function serverSearch(qs){
    results.innerHTML = 'Searching...';
    try{
      const url = '/api/users?search='+encodeURIComponent(qs)+'&limit=50';
      const res = await fetch(url);
      if(!res.ok) throw new Error('Search failed');
      const json = await res.json();
      renderList(json.results || []);
    }catch(err){
      results.innerHTML = '<div class="notice">Server search error: '+err.message+'</div>';
    }
  }

  function clientFuzzy(qs){
    results.innerHTML = 'Loading all records for fuzzy search...';
    (async()=>{
      try{
        if(!allCache) {
          const res = await fetch('/api/users/all');
          if(!res.ok) throw new Error('Could not load all users');
          allCache = await res.json();
        }
        const out = fuzzyFilter(allCache, qs);
        renderList(out.slice(0,100));
      }catch(err){
        results.innerHTML = '<div class="notice">Fuzzy search error: '+err.message+'</div>';
      }
    })();
  }

  function fuzzyFilter(rows, qs){
    const q = String(qs||'').toLowerCase().trim();
    if(!q) return rows;
    return rows.map(r=>({r,score:scoreRow(r,q)})).sort((a,b)=>b.score-a.score).filter(x=>x.score>0).map(x=>x.r);
  }
  function scoreRow(r,q){
    let s=0;
    const hay = (r.name+' '+r.city+' '+r.country+' '+(r.story||'')).toLowerCase();
    if(hay.includes(q)) s+=100;
    const tokens = q.split(/\s+/).filter(Boolean);
    for(const t of tokens){ if(hay.includes(t)) s+=10; }
    const idx = hay.indexOf(q); if(idx>=0) s += Math.max(0,30 - idx);
    return s;
  }

  function renderList(list){
    if(!list || list.length===0){ results.innerHTML = '<div class="notice">No results</div>'; return }
    results.innerHTML = list.map(u=>makeItemHtml(u)).join('\n');
    Array.from(results.querySelectorAll('.item')).forEach(el=>{
      el.querySelector('.view').addEventListener('click',()=>openDetail(el.dataset.id));
      el.addEventListener('click', e=>{ if(e.target.classList.contains('view')) return; openDetail(el.dataset.id); });
    });
  }

  async function openDetail(id){
    detail.innerHTML = 'Loading...';
    try{
      const res = await fetch('/api/users/'+encodeURIComponent(id));
      if(!res.ok) throw new Error('Could not load');
      const u = await res.json();
      detail.innerHTML = `
        <div class="item">
          <img class="photo" src="${u.photo||''}" />
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${escapeHtml(u.name)}</strong> — ${escapeHtml(u.city||'')} ${u.country?'- '+escapeHtml(u.country):''}</div>
              <div class="controls">
                <button id="editBtn">Edit Story</button>
              </div>
            </div>
            <div class="story" id="storyText">${escapeHtml(u.story||'')}</div>
            <div class="editor" id="editorArea" style="display:none">
              <textarea id="storyInput" rows="6" style="width:100%">${escapeHtml(u.story||'')}</textarea>
              <div style="margin-top:8px"><button id="saveBtn">Save</button> <button id="cancelBtn">Cancel</button></div>
            </div>
            <div id="editMsg" style="margin-top:8px;color:#666;font-size:13px"></div>
          </div>
        </div>
      `;
      $('editBtn').addEventListener('click', ()=> startEdit(u.id));
    }catch(err){ detail.innerHTML = '<div class="notice">Error: '+err.message+'</div>' }
  }

  function hasToken(){ return !!localStorage.getItem('fts_demo_token'); }
  function getToken(){ return localStorage.getItem('fts_demo_token'); }

  function startEdit(id){
    if(!hasToken()){
      alert('You must login as admin to edit. Click Login and enter the admin password.');
      return;
    }
    $('storyText').style.display='none';
    $('editorArea').style.display='block';
    $('cancelBtn').addEventListener('click',()=>{ $('editorArea').style.display='none'; $('storyText').style.display='block'; });
    $('saveBtn').addEventListener('click', async ()=>{
      const story = $('storyInput').value;
      $('editMsg').textContent = 'Saving...';
      try{
        const res = await fetch('/api/users/'+encodeURIComponent(id),{
          method:'PUT',
          headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+getToken() },
          body: JSON.stringify({ story })
        });
        const json = await res.json();
        if(!res.ok) throw new Error(json && json.error ? json.error : 'Save failed');
        $('editMsg').textContent = 'Saved.';
        $('editorArea').style.display='none';
        $('storyText').textContent = story;
        $('storyText').style.display='block';
      }catch(err){ $('editMsg').textContent = 'Error: '+err.message }
    });
  }

  loginBtn.addEventListener('click', async ()=>{
    if(hasToken()){
      if(confirm('Logout?')){ localStorage.removeItem('fts_demo_token'); loginBtn.textContent='Login'; alert('Logged out'); }
      return;
    }
    const pw = prompt('Admin password: (default: adminpass)');
    if(!pw) return;
    try{
      const res = await fetch('/api/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pw }) });
      const json = await res.json();
      if(!res.ok) throw new Error(json && json.error? json.error : 'Login failed');
      localStorage.setItem('fts_demo_token', json.token);
      loginBtn.textContent = 'Logout';
      alert('Logged in — token stored (expires in 1 hour)');
    }catch(err){ alert('Login error: '+err.message) }
  });

  searchBtn.addEventListener('click', ()=> serverSearch(q.value));
  fuzzyBtn.addEventListener('click', ()=> clientFuzzy(q.value));
  refreshBtn.addEventListener('click', ()=>{ allCache=null; results.innerHTML=''; detail.innerHTML=''; });

  if(hasToken()) loginBtn.textContent='Logout';

  await serverSearch('');
})();
</script>
</body>
</html>
</body>
</html>
