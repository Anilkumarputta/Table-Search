<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Table Search Workspace</title>
  <link rel="stylesheet" href="/styles.css">
  <a class="skip-link" href="#mainContent">Skip to content</a>
  <div class="app-shell">
    <header class="topbar card" role="banner">
      <div class="brand-wrap">
        <img src="/logo-table-search.svg" class="brand-logo" alt="Table Search logo" />
        <div>
        <p class="eyebrow">Data Operations â€¢ V4 Experience</p>
        <h1>Table Search Workspace</h1>
        <p class="subtitle">Professional search cockpit with server FTS, fuzzy matching, analytics, and collaboration-friendly profile tools.</p>
        </div>
      </div>
      <div class="top-actions">
        <button id="themeBtn" class="btn btn-ghost" aria-label="Toggle color theme">ðŸŒ™ Dark</button>
        <button id="compactBtn" class="btn btn-ghost" aria-pressed="false">Compact mode</button>
        <button id="loginBtn" class="btn btn-primary">Login</button>
      </div>
    </header>
      <div class="top-actions">
        <button id="themeBtn" class="btn btn-ghost" aria-label="Toggle color theme">ðŸŒ™ Dark</button>
        <button id="compactBtn" class="btn btn-ghost" aria-pressed="false">Compact mode</button>
        <button id="loginBtn" class="btn btn-primary">Login</button>
      </div>
    </header>

    <section class="summary-strip" aria-label="Dashboard summary">
      <article class="metric card"><p>Total users</p><strong id="metricTotalUsers">--</strong></article>
      <article class="metric card"><p>Matches</p><strong id="metricMatches">--</strong></article>
      <article class="metric card"><p>Last query time</p><strong id="metricQueryMs">--</strong></article>
      <article class="metric card"><p>Search mode</p><strong id="metricMode">Server FTS</strong></article>
    </section>

    <section class="control-panel card" aria-label="Search and filters">
      <div class="search-row">
        <label for="q" class="field-label">Search query</label>
        <div class="search-input-wrap">
          <span class="search-icon" aria-hidden="true">ðŸ”Ž</span>
          <input id="q" type="text" placeholder="Search by name, city, country, or story" autocomplete="off" />
          <datalist id="recentSearches"></datalist>
        </div>
      </div>

      <div class="actions-row sticky-controls">
        <button id="searchBtn" class="btn btn-primary">Server Search</button>
        <button id="fuzzyBtn" class="btn btn-secondary">Fuzzy Search</button>
        <button id="clearBtn" class="btn btn-ghost">Clear</button>
        <button id="saveViewBtn" class="btn btn-ghost">Save current view</button>
      </div>

      <div class="toolbar-grid">
        <div>
          <p class="field-label">Filters</p>
          <div id="filterChips" class="chips-row" role="group" aria-label="Quick filters">
            <button data-filter="all" class="chip-btn active">All</button>
            <button data-filter="usa" class="chip-btn">USA</button>
            <button data-filter="india" class="chip-btn">India</button>
            <button data-filter="hasStory" class="chip-btn">Has Story</button>
            <button data-filter="recent" class="chip-btn">Recently Viewed</button>
          </div>
        </div>

        <div class="inline-controls">
          <label for="savedViews" class="field-label">Saved views</label>
          <select id="savedViews" aria-label="Saved views">
            <option value="">Select saved view</option>
          </select>
        </div>

        <div class="inline-controls">
          <label for="sortSelect" class="field-label">Sort</label>
          <select id="sortSelect" aria-label="Sort by">
            <option value="name:asc">Name A-Z</option>
            <option value="name:desc">Name Z-A</option>
            <option value="country:asc">Country</option>
            <option value="city:asc">City</option>
            <option value="id:asc">ID</option>
          </select>
        </div>

        <div class="inline-controls">
          <label for="pageSize" class="field-label">Page size</label>
          <select id="pageSize" aria-label="Results per page">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
      <p class="notice">Shortcuts: <kbd>/</kbd> focus search, <kbd>Enter</kbd> search, <kbd>Esc</kbd> clear, <kbd>Shift+F</kbd> fuzzy mode.</p>
    </section>

    <main id="mainContent" class="dashboard-grid" role="main">
      <section>
        <div class="section-head">
          <h2>Results</h2>
          <span id="resultCount" class="chip"></span>
        </div>
        <div id="results" class="list card"></div>
        <div class="pagination" aria-label="Pagination">
          <button id="prevPage" class="btn btn-ghost btn-mini">Previous</button>
          <span id="pageInfo" class="page-info">Page 1</span>
          <button id="nextPage" class="btn btn-ghost btn-mini">Next</button>
        </div>
      </section>

      <section>
        <div class="section-head sticky-head">
          <h2>Profile details</h2>
          <div class="detail-actions">
            <button id="pinCompareBtn" class="btn btn-ghost btn-mini" disabled>Pin to compare</button>
            <button id="toggleReadBtn" class="btn btn-ghost btn-mini" disabled>Expanded view</button>
          </div>
        </div>
        <div id="detail" class="detail card empty-state">Select a record to preview details.</div>
      </section>
    </main>

    <section id="comparePanel" class="compare-panel card hidden" aria-label="Compare profiles"></section>

    <footer>
      API: <code>/api/users</code>, <code>/api/users/all</code>, <code>/api/users/:id</code>, <code>/api/login</code>, <code>/api/users/:id (PUT)</code>
    </footer>
  </div>

  <div id="toastRegion" class="toast-region" aria-live="polite" aria-atomic="true"></div>

  <dialog id="loginModal" class="login-modal" aria-label="Admin login">
    <form id="loginForm" method="dialog">
      <h3>Admin Login</h3>
      <p>Enter your admin password to enable story editing.</p>
      <label for="passwordInput" class="field-label">Password</label>
      <input id="passwordInput" type="password" required />
      <div class="modal-actions">
        <button value="cancel" class="btn btn-ghost" type="button" id="cancelLoginBtn">Cancel</button>
        <button value="submit" class="btn btn-primary" type="submit">Login</button>
      </div>
    </form>
  </dialog>

  

<script>
(async function(){
  const $ = id=>document.getElementById(id);
  const q = $("q");
  const results = $("results");
  const detail = $("detail");
  const resultCount = $("resultCount");
  const searchBtn = $("searchBtn");
  const fuzzyBtn = $("fuzzyBtn");
  const clearBtn = $("clearBtn");
  const loginBtn = $("loginBtn");
  const themeBtn = $("themeBtn");
  const compactBtn = $("compactBtn");
  const sortSelect = $("sortSelect");
  const pageSize = $("pageSize");
  const savedViews = $("savedViews");
  const saveViewBtn = $("saveViewBtn");
  const recentSearches = $("recentSearches");
  const pageInfo = $("pageInfo");
  const prevPage = $("prevPage");
  const nextPage = $("nextPage");
  const pinCompareBtn = $("pinCompareBtn");
  const toggleReadBtn = $("toggleReadBtn");
  const FILTERS = {
    all: () => true,
    usa: r => (r.country || '').toLowerCase() === 'usa',
    india: r => (r.country || '').toLowerCase() === 'india',
    hasStory: r => Boolean((r.story || '').trim()),
    recent: r => state.recentViewed.includes(String(r.id))
  };

  // ...existing code...

  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function truncate(s,n){return s && s.length>n ? s.slice(0,n-1)+'â€¦' : s}

  async function serverSearch(qs){
    results.innerHTML = 'Searching...';
    try{
      const url = '/api/users?search='+encodeURIComponent(qs)+'&limit=50';
      const res = await fetch(url);
      if(!res.ok) throw new Error('Search failed');
      const json = await res.json();
      renderList(json.results || []);
    }catch(err){
      results.innerHTML = '<div class="notice">Server search error: '+err.message+'</div>';
    }
  }

  function clientFuzzy(qs){
    results.innerHTML = 'Loading all records for fuzzy search...';
    (async()=>{
      try{
        if(!allCache) {
          const res = await fetch('/api/users/all');
          if(!res.ok) throw new Error('Could not load all users');
          allCache = await res.json();
        }
        const out = fuzzyFilter(allCache, qs);
        renderList(out.slice(0,100));
      }catch(err){
        results.innerHTML = '<div class="notice">Fuzzy search error: '+err.message+'</div>';
      }
    })();
  }

  function fuzzyFilter(rows, qs){
    const q = String(qs||'').toLowerCase().trim();
    if(!q) return rows;
    return rows.map(r=>({r,score:scoreRow(r,q)})).sort((a,b)=>b.score-a.score).filter(x=>x.score>0).map(x=>x.r);
  }
  function scoreRow(r,q){
    let s=0;
    const hay = (r.name+' '+r.city+' '+r.country+' '+(r.story||'')).toLowerCase();
    if(hay.includes(q)) s+=100;
    const tokens = q.split(/\s+/).filter(Boolean);
    for(const t of tokens){ if(hay.includes(t)) s+=10; }
    const idx = hay.indexOf(q); if(idx>=0) s += Math.max(0,30 - idx);
    return s;
  }

  // ...existing code...

  async function openDetail(id){
    detail.innerHTML = 'Loading...';
    try{
      const res = await fetch('/api/users/'+encodeURIComponent(id));
      if(!res.ok) throw new Error('Could not load');
      const u = await res.json();
      detail.innerHTML = `
        <div class="item">
          <img class="photo" src="${u.photo||''}" />
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${escapeHtml(u.name)}</strong> â€” ${escapeHtml(u.city||'')} ${u.country?'- '+escapeHtml(u.country):''}</div>
              <div class="controls">
                <button id="editBtn">Edit Story</button>
              </div>
            </div>
            <div class="story" id="storyText">${escapeHtml(u.story||'')}</div>
            <div class="editor" id="editorArea" style="display:none">
              <textarea id="storyInput" rows="6" style="width:100%">${escapeHtml(u.story||'')}</textarea>
              <div style="margin-top:8px"><button id="saveBtn">Save</button> <button id="cancelBtn">Cancel</button></div>
            </div>
            <div id="editMsg" style="margin-top:8px;color:#666;font-size:13px"></div>
          </div>
        </div>
      `;
      $('editBtn').addEventListener('click', ()=> startEdit(u.id));
    }catch(err){ detail.innerHTML = '<div class="notice">Error: '+err.message+'</div>' }
  }

  function hasToken(){ return !!localStorage.getItem('fts_demo_token'); }
  function getToken(){ return localStorage.getItem('fts_demo_token'); }

  function startEdit(id){
    if(!hasToken()){
      alert('You must login as admin to edit. Click Login and enter the admin password.');
      return;
    }
    $('storyText').style.display='none';
    $('editorArea').style.display='block';
    $('cancelBtn').addEventListener('click',()=>{ $('editorArea').style.display='none'; $('storyText').style.display='block'; });
    $('saveBtn').addEventListener('click', async ()=>{
      const story = $('storyInput').value;
      $('editMsg').textContent = 'Saving...';
      try{
        const res = await fetch('/api/users/'+encodeURIComponent(id),{
          method:'PUT',
          headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+getToken() },
          body: JSON.stringify({ story })
        });
        const json = await res.json();
        if(!res.ok) throw new Error(json && json.error ? json.error : 'Save failed');
        $('editMsg').textContent = 'Saved.';
        $('editorArea').style.display='none';
        $('storyText').textContent = story;
        $('storyText').style.display='block';
      }catch(err){ $('editMsg').textContent = 'Error: '+err.message }
    });
  }

  loginBtn.addEventListener('click', async ()=>{
    if(hasToken()){
      if(confirm('Logout?')){ localStorage.removeItem('fts_demo_token'); loginBtn.textContent='Login'; alert('Logged out'); }
      return;
    }
    const pw = prompt('Admin password: (default: adminpass)');
    if(!pw) return;
    try{
      const res = await fetch('/api/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pw }) });
      const json = await res.json();
      if(!res.ok) throw new Error(json && json.error? json.error : 'Login failed');
      localStorage.setItem('fts_demo_token', json.token);
      loginBtn.textContent = 'Logout';
      alert('Logged in â€” token stored (expires in 1 hour)');
    }catch(err){ alert('Login error: '+err.message) }
  });

  searchBtn.addEventListener('click', ()=> serverSearch(q.value));
  fuzzyBtn.addEventListener('click', ()=> clientFuzzy(q.value));
  refreshBtn.addEventListener('click', ()=>{ allCache=null; results.innerHTML=''; detail.innerHTML=''; });

  if(hasToken()) loginBtn.textContent='Logout';

  await serverSearch('');
})();
</script>
</body>
</html>
</body>
</html>
